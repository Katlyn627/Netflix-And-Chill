<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Netflix and Chill</title>
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#E50914">
    <link rel="stylesheet" href="src/styles/main.css">
    <link rel="stylesheet" href="src/styles/login.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-banner">
                <img src="assets/images/logo.png" alt="Netflix & Chill Logo">
            </div>
            <p class="tagline">Welcome Back!</p>
        </header>

        <main>
            <div class="login-container">
                <div class="card login-card">
                    <h2>Login to Your Account</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="email">Username or Email:</label>
                            <input type="text" id="email" name="email" placeholder="Enter your username or email" required>
                            <p class="input-hint">Use your username or email from when you created your profile</p>
                        </div>
                        <div class="form-group">
                            <label for="password">Password:</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="password" name="password" placeholder="Enter your password" required>
                                <button type="button" class="toggle-password" id="toggle-password">Show</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-large">Login</button>
                    </form>
                    
                    <div class="auth-divider" style="margin: 20px 0; text-align: center; position: relative;">
                        <span style="background: white; padding: 0 10px; position: relative; z-index: 1;">OR</span>
                        <div style="border-top: 1px solid #ddd; position: absolute; top: 50%; left: 0; right: 0; z-index: 0;"></div>
                    </div>
                    
                    <button id="auth0-login-btn" class="btn btn-secondary btn-large" style="width: 100%; margin-bottom: 10px; display: none;">
                        üîê Login with Auth0
                    </button>
                    
                    <div class="login-footer">
                        <p><a href="forgot-password.html">Forgot Password?</a></p>
                        <p>Don't have an account? <a href="profile.html">Create Profile</a></p>
                        <p><a href="homepage.html">Back to Home</a></p>
                    </div>
                </div>

                <div id="error-message" class="error-message" style="display: none;"></div>
            </div>
        </main>

        <footer>
            <p>&copy; 2024 Netflix and Chill - Find your perfect streaming partner</p>
        </footer>
    </div>

    <script src="src/utils/errorHandler.js"></script>
    <script src="src/services/api.js"></script>
    
    <!-- Auth0 SPA SDK -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    
    <!-- Auth0 Configuration Loader -->
    <!-- This script loads Auth0 configuration from the backend API -->
    <!-- Configuration values are set in the .env file on the server -->
    <!-- See .env.example for required Auth0 environment variables -->
    <script src="src/config/auth0-loader.js"></script>
    <script src="src/utils/auth0-config.js"></script>
    
    <script src="src/components/login.js"></script>
    
    <script>
        // Add Auth0 login handler after config is loaded
        (async function setupAuth0Login() {
            console.log('üîê Setting up Auth0 login...');
            
            // Wait for Auth0 configuration to be loaded
            if (window.auth0ConfigReady) {
                console.log('‚è≥ Waiting for Auth0 config to load...');
                await window.auth0ConfigReady;
            }
            
            const auth0Button = document.getElementById('auth0-login-btn');
            const divider = document.querySelector('.auth-divider');
            const errorDiv = document.getElementById('error-message');
            
            // Check if user came here expecting Auth0 login
            const urlParams = new URLSearchParams(window.location.search);
            const auth0Required = urlParams.get('auth0_required') === 'true';
            const autoLogin = urlParams.get('auto_login') === 'true';
            const returnTo = urlParams.get('returnTo');
            const error = urlParams.get('error');
            
            console.log('üìã Login page parameters:', {
                auth0Required,
                autoLogin,
                returnTo,
                error,
                auth0Configured: window.AUTH0_CONFIGURED
            });
            
            // Show Auth0 error if present
            if (error) {
                console.error('‚ùå Auth0 error from callback:', error);
                
                // Provide specific guidance based on error type
                let errorMessage = '<strong>Authentication Failed</strong><br>';
                let errorDetails = '';
                
                if (error === 'access_denied') {
                    errorMessage += 'Error: Access Denied<br><br>';
                    errorDetails = `
                        <small><strong>Common causes:</strong></small><br>
                        <small>‚Ä¢ Callback URL mismatch in Auth0 Dashboard</small><br>
                        <small>‚Ä¢ Missing permissions or scopes</small><br>
                        <small>‚Ä¢ Application not enabled for this connection</small><br><br>
                        <small><strong>To fix:</strong></small><br>
                        <small>1. Check Auth0 Dashboard ‚Üí Your App ‚Üí Settings</small><br>
                        <small>2. Verify "Allowed Callback URLs" includes: ${window.location.origin}/callback.html</small><br>
                        <small>3. Verify "Allowed Web Origins" includes: ${window.location.origin}</small><br>
                        <small>4. Ensure Application Type is "Single Page Application"</small><br><br>
                        <small>See docs/auth/AUTH0_ERRORS_QUICK_FIX.md for more help.</small>
                    `;
                } else {
                    errorMessage += `Error: ${error}<br><br>`;
                    errorDetails = `
                        <small>Please try again or use traditional login.</small><br>
                        <small>If this persists, check Auth0 Dashboard configuration.</small><br>
                        <small>See docs/auth/AUTH0_ERRORS_QUICK_FIX.md for troubleshooting.</small>
                    `;
                }
                
                errorDiv.innerHTML = errorMessage + errorDetails;
                errorDiv.style.display = 'block';
            }
            
            // Note: returnTo is passed via appState to Auth0, which will be available
            // in callback.html after successful authentication
            
            // Only show and enable Auth0 button if it's configured
            if (window.AUTH0_CONFIGURED) {
                console.log('‚úÖ Auth0 is configured, showing login button');
                auth0Button.style.display = 'block';
                auth0Button.addEventListener('click', async () => {
                    try {
                        console.log('üîë Initiating Auth0 login...');
                        // Clear any previous errors
                        errorDiv.style.display = 'none';
                        
                        // Pass returnTo as appState to Auth0
                        const options = {};
                        if (returnTo) {
                            options.appState = { returnTo };
                            console.log('üéØ Will return to:', returnTo);
                        }
                        await Auth0Manager.login(options);
                    } catch (error) {
                        console.error('‚ùå Auth0 login error:', error);
                        errorDiv.innerHTML = `
                            <strong>Failed to login with Auth0</strong><br>
                            ${error.message || 'Unknown error'}<br><br>
                            <small>Please try again or use traditional login.</small>
                        `;
                        errorDiv.style.display = 'block';
                    }
                });
                
                // Auto-trigger Auth0 login if requested
                if (autoLogin && !error) {
                    console.log('üöÄ Auto-triggering Auth0 login...');
                    setTimeout(async () => {
                        try {
                            // Pass returnTo as appState to Auth0
                            const options = {};
                            if (returnTo) {
                                options.appState = { returnTo };
                                console.log('üéØ Will return to:', returnTo);
                            }
                            await Auth0Manager.login(options);
                        } catch (error) {
                            console.error('‚ùå Auto Auth0 login error:', error);
                            errorDiv.innerHTML = `
                                <strong>Failed to automatically login with Auth0</strong><br>
                                ${error.message || 'Unknown error'}<br><br>
                                <small>Please click the Auth0 login button or use traditional login.</small>
                            `;
                            errorDiv.style.display = 'block';
                        }
                    }, 500);
                }
            } else {
                console.warn('‚ö†Ô∏è Auth0 is not configured');
                // Hide Auth0 button and divider if Auth0 is not configured
                auth0Button.style.display = 'none';
                if (divider) {
                    divider.style.display = 'none';
                }
                
                // Show message if Auth0 was expected but not configured
                if (auth0Required) {
                    console.error('‚ùå Auth0 required but not configured');
                    errorDiv.innerHTML = `
                        <strong>Auth0 authentication is not configured.</strong><br>
                        Please use traditional login or contact the administrator to enable Auth0.<br>
                        <small>See AUTH0_SETUP_GUIDE.md for setup instructions.</small>
                    `;
                    errorDiv.style.display = 'block';
                }
                
                console.info('‚ÑπÔ∏è Auth0 login is not available. Please use traditional login.');
            }
        })();
    </script>
</body>
</html>
